# 部品展開マスタシステム

完成品と構成部品の関係を管理し、商品コード照合を行うシステムです。

## 📋 機能概要

### 1. 部品展開マスタのアップロード 📤
- **Excel/CSV形式**に対応
- ヘッダー行を指定できます（1行目、2行目以降に対応）
- 完成品とその構成部品情報を一括登録
- ファイルサイズ上限：16MB

### 2. マスタ閲覧 👁️
- アップロード済みのマスタを階層表示
- 完成品ごとに構成部品と数量を確認
- 🔍 **検索機能**：完成品コード/商品名で検索可能
- 完成品をクリックして詳細表示/折りたたみ

### 3. 完成品照合 🔍
- 商品コード一覧ファイルをアップロード
- マスタの完成品コードと自動照合
- マッチ/未マッチを判定
- 各完成品の構成部品情報を表示
- 結果を **3シート構成** のExcelで出力

---

## 📁 ファイル形式

### マスタアップロード用 Excel/CSV

| 列 | データ | 説明 |
|----|--------|------|
| A | 完成品コード | 完成品照合に使用（重複可） |
| B | 完成品商品名 | 完成品の名称 |
| C | 構成部品商品コード（確認用） | 参考情報 |
| D | 構成部品商品コード | 実際の構成部品コード |
| E | 入数 | パッケージ入数 |
| F | 箱数 | 箱の数量 |
| G | 構成数量 | 完成品に必要な部品数 |

**注意事項：**
- ヘッダー行が2行目以降にある場合は、アップロード時に行番号を指定してください
- 完成品コードは1つの完成品に複数の構成部品がある場合、繰り返されます

### 照合用 Excel/CSV

- **A列に商品コード**を入力（複数行可）
- その他の列は無視されます

**例：**
```
商品コード
完成品001
完成品002
存在しないコード
完成品003
```

---

## 🚀 クイックスタート

### インストール

```bash
# リポジトリをクローン
cd /workspaces/-

# 必要なパッケージをインストール
pip install -r requirements.txt
```

### 起動

```bash
# アプリケーション起動
python src/app.py

# ブラウザでアクセス
# http://localhost:5000
```

### 使用開始

1. **📤 マスタアップロード** タブでマスタファイルをアップロード
2. **👁️ マスタ閲覧** タブで登録内容を確認
3. **🔍 完成品照合** タブで商品コード照合を実行
4. 📊 結果をExcelでダウンロード

---

## 📊 Excel出力形式（3シート）

### Sheet 1: Matched
照合に成功した完成品一覧
- Row: 照合ファイルの行番号
- Product Code: 商品コード
- Finished Product Name: 完成品名
- Parts Count: 構成部品数

### Sheet 2: Unmatched
照合に失敗した商品一覧
- Row: 照合ファイルの行番号
- Product Code: 商品コード
- Status: ステータス（Unmatched）

### Sheet 3: Detail
部品展開マスタ形式の詳細データ
- 完成品コード
- 完成品商品名
- 構成部品商品コード
- 入数
- 箱数
- 構成数量

**Detail シートは部品展開マスタと同じ形式のため、他のシステムと連携可能です。**

---

## 🔒 セキュリティ機能

### ✅ 実装済みセキュリティ対策

1. **ファイル検証**
   - 許可されたファイル形式（.xlsx, .xls, .csv）のみ受け入れ
   - ファイルサイズ制限（16MB）

2. **入力検証**
   - ヘッダー行番号のバリデーション（1～10行目のみ）
   - 空文字列・不正な値の処理

3. **エラーハンドリング**
   - ファイル読込エラーの詳細ログ出力
   - ユーザーフレンドリーなエラーメッセージ

4. **データ分離**
   - アップロードファイルは一時ディレクトリに保存
   - 処理後は自動削除

### 🛡️ 推奨される追加対策（本番環境）

```python
# 環境変数設定例 (.env)
FLASK_ENV=production
SECRET_KEY=your-secret-key-here
MAX_CONTENT_LENGTH=16777216  # 16MB
```

推奨パッケージ（本番環境用）：
```bash
pip install python-dotenv  # 環境変数管理
pip install gunicorn       # 本番WSGIサーバー
pip install flask-limiter  # レート制限
```

本番環境での起動：
```bash
# Gunicornを使用
gunicorn -w 4 -b 0.0.0.0:5000 src.app:app

# または環境変数で設定
export FLASK_ENV=production
python src/app.py
```

---

## 📋 システム要件

- Python 3.8以上
- pandas
- openpyxl
- Flask

---

## 🗂️ プロジェクト構造

```
/workspaces/-/
├── src/
│   └── app.py                 # Flaskメインアプリケーション
├── templates/
│   └── index.html             # フロントエンドHTML
├── static/
│   ├── style.css              # スタイルシート
│   └── script.js              # JavaScriptロジック
├── requirements.txt           # 依存パッケージ
├── create_samples.py          # サンプルファイル生成スクリプト
├── sample_master.xlsx         # テスト用マスタファイル
├── sample_matching.xlsx       # テスト用照合ファイル
└── README_APP.md              # このファイル
```

---

## 🧪 テスト方法

1. **サンプルファイルの生成**
```bash
python create_samples.py
```

2. **マスタアップロード**
   - `sample_master.xlsx` をアップロード

3. **照合実行**
   - `sample_matching.xlsx` をアップロード
   - 結果を確認

---

## 🐛 トラブルシューティング

### ポート5000が使用中
```bash
# プロセスを確認
lsof -i :5000

# プロセスを終了
kill -9 <PID>
```

### ファイルが読み込めない
- ファイル形式を確認（.xlsx, .xls, .csv）
- ヘッダー行の番号を確認
- ファイルが破損していないか確認

### メモリ不足
- ファイルサイズを削減
- MAX_CONTENT_LENGTH を調整

---

## 📝 ライセンス

MITライセンス

---

## 💡 今後の拡張予定

- [ ] データベース対応
- [ ] ユーザー認証
- [ ] 複数ユーザーでのマスタ共有
- [ ] 更新履歴の管理
- [ ] APIエンドポイント追加
- [ ] CSVダウンロード機能

---

## 📧 サポート

問題が発生した場合は、ログファイルを確認してください：
```bash
tail -100 /tmp/app.log
```

